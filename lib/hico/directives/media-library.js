var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};define(["qlik","require","qvangular","ng!$compile","ng!$timeout","text!./media-library.html","./modal-dialog","../prefix","../translations/translation","../services/media-service","../../external/leonardo-ui/leonardo-ui"],function(e,t,n,i,r,a,o,c,l,d,s){function u(){return{scope:{mediaUrl:"<",onConfirm:"&",onCancel:"&"},controller:["$scope","$element",f],controllerAs:"$ctrl",template:a}}function f(e,n){function i(t){var n=t.target,i=n.files;r(function(){i.length?(T.importFilesInputString=1===i.length?i[0].name:i.length+" "+e.trans("FILES"),T.previewFiles(i)):T.importFilesInputString=""})}function a(t){var n=e.currentItem,i=h.getMediaItemByName(n.targetName),r=n.name!==n.targetName;if(t)switch(t.keyCode){case 13:T.applyChanges();break;case 27:T.resetEditingMedia(!0)}n.targetNameInUse=r&&i}function c(){t(["general.services/media-library/media-library"],function(t){r(function(){var n=e.state;A(E.HIDDEN),t.show({onConfirm:function(e){T.addFromUrl(e),A(E.DEFAULT)},onCancel:function(){A(n)}})})})}function d(t){var n=e.trans;u(t).then(function(e){r(function(){T.previewMedia(e.tcMedia),A(E.DEFAULT)})}).catch(function(e){e&&409===e.code?r(function(){o.show({title:n("ATTENTION"),body:n("MEDIA_ALREADY_EXISTS"),buttons:[{text:n("OK")}]})}):!1===e?r(function(){A(E.DEFAULT)}):console.error(e)})}function u(e){return new Promise(function(t,n){e&&e.name!==e.targetName?h.renameMedia(e.name,e.targetName).then(t,n):n(!1)})}function f(e){switch(e){case"from-lib":c();break;case"from-file":A(E.ADD_FROM_FILE);break;case"from-url":A(E.ADD_FROM_URL);break;default:var t=s.popover({content:T.elements.chooseMediaSource.innerHTML,closeOnEscape:!0,dock:"top",alignTo:e.target});[].slice.apply(t.element.querySelectorAll("[data-add-media]")).forEach(function(e){e.addEventListener("click",function(){var e=this.getAttribute("data-add-media");r(function(){f(e)}),t.close()})})}}function m(t){e.isDownloadable&&t&&t.length&&t.forEach(function(e){h.downloadMedia(e.name)})}function I(e,t){var n=[];return Promise.all(e.map(function(e){return h.addMediaFromUrl(e,t).catch(function(t){if(!t||409!==t.code)throw t;n.push(e)})})).then(function(e){return{added:e.filter(function(e){return void 0!==e}),rejected:n}})}function D(e,t){var n=[];return Promise.all(e.map(function(e){return h.addMediaFromFile(e,t).catch(function(t){if(!t||409!==t.code)throw t;n.push(e)})})).then(function(e){return{added:e.filter(function(e){return void 0!==e}),rejected:n}})}function p(e,t){return new Promise(function(n,i){var r=e.rejected;if(r&&r.length){(r[0]instanceof File?D:I)(r,t).then(function(t){return e.added.concat(t.added)},i).then(n,i)}else n(e.added)})}function _(t){var n=e.trans;return new Promise(function(e,i){var a=t.rejected;if(!a.length)return void e(t.added);r(function(){var r=a.map(function(e){return e.name||e}).join("',<br> '");o.show({title:n("MEDIA_ALREADY_EXISTS"),body:"'"+r+"'<br>"+n("RESOLVE_MEDIA_CONFLICT_BODY"),buttons:[{text:n("REPLACE"),handler:function(){p(t,!0).then(e,i)}},{text:n("RENAME"),handler:function(){p(t).then(e,i)}},{text:n("CANCEL")}]})})})}function v(t){h.getMediaItems().then(function(n){var i=null,a=e.mediaUrl,o=t||a,c=h.isTcMediaUrl(a),l=n.map(function(e){var t=e.tcMedia;return o===t.url&&(i=t),t});-1===l.indexOf(e.currentItem)&&(e.currentItem=null),r(function(){i?(A(E.DEFAULT),T.previewMedia(i)):l.length||a?a?c?(A(E.MEDIA_NOT_FOUND),T.setPreviewSource("")):(A(E.NOT_IN_LIBRARY),T.setPreviewSource(a)):A(E.NO_MEDIA_SELECTED):(A(E.NO_MEDIA_IN_LIBRARY),T.setPreviewSource(""))}),e.mediaItems=l},function(e){console.warn("Error occurred during media update of trueChart media library",e)})}function M(){e.onConfirm({url:e.currentItem.url}),n.remove()}function g(){e.onCancel(),n.remove()}function A(t){e.prevState=e.state,e.state=t||"DEFAULT"}function L(t){return-1!==t.indexOf(e.state)}var T=this;e.trans=l.getTranslation,e.STATES=E,e.state=E.DEFAULT,e.prevState=E.DEFAULT,e.mediaItems=[],e.currentItem=null,e.selectedItems=[],e.selected={},e.filtered=[],e.fileList=[],e.importUrl="",e.isDownloadable=h.isDownloadSupported(),this.apply=M,this.cancel=g,this.inStates=L,this.addMedia=f,this.downloadMedia=m,this.applyChanges=d,this.onNameInputChage=a,n.on("$destroy",function(){e.$destroy(),T.elements=null}),this.$onInit=function(){this.elements={$fileInput:n.find(".hico-file-input"),$filesPreview:n.find(".files-preview"),chooseMediaSource:n.find("#choose-media-source").get(0),previewImage:n.find("#hico-media-lib-preview-img").get(0)},this.elements.$fileInput.on("change",i),v(e.mediaUrl)},this.previewMedia=function(t){t&&t.name&&(L([E.DEFAULT,E.EDIT_MEDIA_LIST])||A(E.DEFAULT),t.data?T.setPreviewSource(t.data):h.getMediaData(t.name).then(function(e){t.data=e,T.setPreviewSource(e)}),e.currentItem=t)},this.setPreviewSource=function(e){T.elements.previewImage.src=e||""},this.previewFiles=function(t){var n=this.elements.$filesPreview,i=[];e.fileList=t;for(var a=0,o=t.length;a<o;a++)i.push(h.fileToData(t[a]));Promise.all(i).then(function(e){var t=document.createDocumentFragment();e.forEach(function(e){var n=new Image;n.alt=e.name,n.src=e.data,n.className="bg-checkered";var i=document.createElement("span");i.innerText=e.name;var r=document.createElement("div");r.appendChild(n),r.appendChild(i),t.appendChild(r)}),r(function(){n.empty(),n.append(t)})},function(e){console.error(e)})},this.setSelectedItems=function(t){if(!t)return void(e.selectedItems=[]);e.selectedItems=e.mediaItems.filter(function(e){return t.hasOwnProperty(e.name)&&t[e.name]})},this.selectAllMedia=function(t){var n=e.selected;e.filtered.forEach(function(e){n[e.name]=t}),this.setSelectedItems(n)},this.addFromUrl=function(t){I([t],!1).then(_).then(function(t){var n=t&&t.length&&t[t.length-1].tcMedia.url;r(function(){v(n),e.importUrl=""})})},this.addFromFiles=function(t){if(t&&t.length){var n=this;D([].slice.apply(t),!1).then(_).then(function(t){var i=t&&t.length&&t[t.length-1].tcMedia.url;r(function(){v(i),n.elements.$fileInput.get(0).value="",n.elements.$filesPreview.empty(),e.fileList=[]})}).catch(function(e){console.error(e)})}},this.removeMedia=function(t){if(t&&t.length){var n=e.trans,i=t.map(function(e){return e.name}).join("', '");o.show({title:n("DELETE_MEDIA")+"?",body:"'"+i+"' "+n("DELETE_MEDIA_BODY"),buttons:[{text:n("DELETE"),handler:function(){for(var n=[],i=null,r=e.mediaItems,a=r.length-1;a>=0;a--){i=r[a];var o=t.indexOf(i);if(-1!==o)n.push(h.removeMedia(i.name)),t.splice(o,1),i=null;else if(!t.length)break}Promise.all(n).then(function(){v(i&&i.url)})}},{text:n("CANCEL")}]})}},this.startEditingMediaList=function(){A(E.EDIT_MEDIA_LIST)},this.stopEditingMediaList=function(){e.selected={},this.setSelectedItems(),this.selectAllMedia(!1),A(E.DEFAULT)},this.startEditingMedia=function(e){this.resetEditingMedia(),e&&(e.targetName=e.name,e.targetNameInUse=!1,this.editingMedia=e,A(E.EDIT_CURRENT_MEDIA))},this.resetEditingMedia=function(e){this.editingMedia&&(this.editingMedia.targetName=this.editingMedia.name),e&&A(E.DEFAULT)},this.resetChages=function(e){e.targetName=e.name,a()}}var m=d.getInstance(e.currApp().id),h=m.mediaProvider,E={DEFAULT:"DEFAULT",HIDDEN:"HIDDEN",NOT_IN_LIBRARY:"NOT_IN_LIBRARY",NO_MEDIA_IN_LIBRARY:"NO_MEDIA_IN_LIBRARY",NO_MEDIA_SELECTED:"NO_MEDIA_SELECTED",CHOOSE_MEDIA_SOURCE:"CHOOSE_MEDIA_SOURCE",ADD_FROM_LIB:"ADD_FROM_LIB",ADD_FROM_FILE:"ADD_FROM_FILE",ADD_FROM_URL:"ADD_FROM_URL",EDIT_MEDIA_LIST:"EDIT_MEDIA_LIST",EDIT_CURRENT_MEDIA:"EDIT_CURRENT_MEDIA",MEDIA_NOT_FOUND:"MEDIA_NOT_FOUND"};return n.directive(c+"MediaLibrary",[u]),u.show=function(e){var t=void 0,r=void 0,a="object"===(void 0===e?"undefined":_typeof(e))?e:{},o=a.scope||n.$rootScope.$new();o.onConfirm=a.onConfirm,o.onCancel=a.onCancel,o.mediaUrl=a.mediaUrl,t="<"+c+'-media-library on-confirm="onConfirm(url)" on-cancel="onCancel()" media-url="mediaUrl"></'+c+"-media-library>",r=i(t)(o),document.body.appendChild(r[0])},u});