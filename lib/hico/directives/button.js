define(["jquery","qlik","angular","qvangular","ng!$q","text!./button.html","../prefix","../services/media-service","../services/action-service","../services/qlik-service"],function(t,e,n,o,i,s,a,r){function l(){return{restrict:"A",scope:{updateStates:"&onStatesUpdate",states:"<",isTrue:"<",evaluateStates:"<",activeStates:"<",maxStates:"<",inEditMode:"<",scrollingInfo:"<",defaultStyles:"<"},controller:["$scope","$element",a+"ActionService",a+"QlikService",u],controllerAs:"$ctrl",template:s}}function u(t,o,i,s){var a=s.getExtensionScope(t),l=a&&a.ext.model.app||e.currApp(),u=this;this.$element=o,this.$scope=t,this.states=t.states,this.maxStates=t.maxStates||1,this.evaluateStates=!1!==t.evaluateStates,this.activeStates=t.activeStates||[],this.qlikService=s,this.actionService=i,this.mediaProvider=r.getInstance(l.id).mediaProvider,this.isTrue="function"!=typeof t.isTrue?h:t.isTrue,this.inEditMode=t.inEditMode,this.actionsRunning={},this.unwatchChanges=t.$watchGroup(["states","defaultStyles"],function(t,e){u.states=t[0],u.defaultStyles=t[1],u.$onChanges({states:{currentValue:t[0],previousValue:e[0]},defaultStyles:{currentValue:t[1],previousValue:e[1]}})}),o.on("$destroy",this.onDestroy),t.$on("paint",function(){u.refreshActiveStates()}),t.$on("performCustomTrigger",function(t,e){u.activeStates.forEach(function(o){n.extend(t,e),this.doAction(t,o,"custom")},u)}),this.setActiveStates=function(e){u.applyStyles(e,!1,t.defaultStyles,t.scrollingInfo),u.applyClasses(e),u.activeStates=e,t.updateStates({states:e})}}function c(t){var e,n=this,o=JSON.parse(JSON.stringify(t)),s=[],a=n.qlikService.evalExpression,r=i.defer();return t.text&&s.push(n.qlikService.evalExpression(t.text).then(function(t){o.text=t})),t.tooltip&&s.push(n.qlikService.evalExpression(t.tooltip).then(function(t){o.tooltip=t})),t.icon&&s.push(n.qlikService.evalExpression(t.icon).then(function(t){o.icon=t})),t.buttonState&&s.push(n.qlikService.evalExpression(t.buttonState).then(function(t){o.buttonState="-"!==t?t:"normal"})),t.style&&(e=t.style,e.background&&(e.background.color&&s.push(n.qlikService.evalExpression(e.background.color).then(function(t){o.style.background.color="-"!==t?t:void 0})),e.background.hoverColor&&s.push(n.qlikService.evalExpression(e.background.hoverColor).then(function(t){o.style.background.hoverColor="-"!==t?t:void 0})),e.background.image&&s.push(n.qlikService.evalExpression(e.background.image).then(function(t){if("-"===t)o.style.background.image=void 0;else{if(n.mediaProvider.isTcMediaUrl(t))return n.mediaProvider.getMediaDataByUrl(t).then(function(t){o.style.background.image=t});o.style.background.image=t}}))),e.icon&&(e.icon.color&&s.push(n.qlikService.evalExpression(e.icon.color).then(function(t){o.style.icon.color="-"!==t?t:void 0})),e.icon.hoverColor&&s.push(n.qlikService.evalExpression(e.icon.hoverColor).then(function(t){o.style.icon.hoverColor="-"!==t?t:void 0}))),t.style.font&&(e.font.color&&s.push(n.qlikService.evalExpression(e.font.color).then(function(t){o.style.font.color="-"!==t?t:void 0})),e.font.hoverColor&&s.push(n.qlikService.evalExpression(e.font.hoverColor).then(function(t){o.style.font.hoverColor="-"!==t?t:void 0})),e.font.family&&s.push(n.qlikService.evalExpression(e.font.family).then(function(t){o.style.font.family="-"!==t?t:void 0})),e.font.size&&s.push(n.qlikService.evalExpression(e.font.size).then(function(t){o.style.font.size="-"!==t?t:void 0})),e.font.weight&&s.push(n.qlikService.evalExpression(e.font.weight).then(function(t){o.style.font.weight="-"!==t?t:void 0})),e.font.style&&s.push(n.qlikService.evalExpression(e.font.style).then(function(t){o.style.font.style="-"!==t?t:void 0}))),e.border&&(e.border.hoverColor&&s.push(n.qlikService.evalExpression(e.border.hoverColor).then(function(t){o.style.border.hoverColor="-"!==t?t:void 0})),e.border.color&&s.push(n.qlikService.evalExpression(e.border.color).then(function(t){o.style.border.color="-"!==t?t:void 0}))),e.custom&&s.push(a(e.custom).then(function(t){o.style.custom="-"!==t?t:void 0}))),t.triggers&&o.triggers.forEach(function(t){t.actions.forEach(function(t){var e=t.paramsExpr;t.params=t.params||{};for(var o in e)e.hasOwnProperty(o)&&s.push(function(o){return n.qlikService.evalExpression(e[o]).then(function(e){t.params[o]=e})}(o))})}),i.all(s).then(function(){r.resolve(o)}),r.promise}function h(t){return""===(t=t.toString().toLowerCase())||"true"===t||"1"===t||"-1"===t}return o.directive(a+"Button",l),u.prototype={doAction:function(n,o,s){var a=this;this.inEditMode||"edit"===e.navigation.getMode()||a.actionsRunning[s]||this.actionService.getReady().then(function(r){function l(o,c){if(c>=0&&c===o.length)return a.actionsRunning[s]=!1,i.resolve();var h=o[c],f=[h.params],p=r.getAction(h.name);c++;try{return"custom"===h.name&&(f=[t,e,a.$scope,a.$element,u,n,h.params]),i.resolve(p.execute.apply(p,f)).catch(a.qlikService.engineErrorHandler(p,"execute",f)).then(function(){return l(o,c)})}catch(t){console.warn("Error during performing an aciton: ",[{name:h.name,params:h.params},t]),a.actionsRunning[s]=!1}return i.resolve()}var u={isMashUp:!e.navigation.inClient};o.triggers.forEach(function(t){if(t.type===s){if("custom"===t.type&&n.name!==t.name)return;var e=t.actions;a.actionsRunning[s]=!0,l(e,0)}})})},getActiveStates:function(t){var e=0,n=[];if(!this.evaluateStates)return i.all(this.activeStates);for(;e<t.length&&n.length<this.maxStates;)this.isTrue(t[e].condition)&&n.push(t[e]),e++;return i.all(n.map(c,this))},refreshActiveStates:function(){this.getActiveStates(this.states).then(this.setActiveStates)},applyStyles:function(t,e,o,i){t.forEach(function(t){if(t.style){var s={},r={},l={},u=t.layout,c=t.style.border,h=t.style.background,f=t.style.icon,p=t.style.font,d=e&&t.hasActions&&(!t.buttonState||"normal"===t.buttonState);t.buttonType&&"simple"!==t.buttonType||(s=n.extend({},o),"hico"===a&&d&&(s["background-color"]="rgba(159,159,159,0.4)")),p&&(s.color=(d?p.hoverColor:p.color)||s.color,p.family&&(s["font-family"]=p.family),p.size&&!isNaN(s["font-size"]=p.size)&&(s["font-size"]+="px"),p.weight&&(s["font-weight"]=p.weight),p.style&&(s["font-style"]=p.style));var v=u.width+(isNaN(u.width)?"":"px");s.width=v,s["min-width"]=v;var g=u.height+(isNaN(u.height)?"":"px");if(s.height=g,s["min-height"]=g,s["text-align"]=u.hTextAlign,s["vertical-align"]=u.vAlign,s["justify-content"]=u.hContentAlign,s["align-items"]=u.vContentAlign,s.padding="none"===u.padding?0:u.padding,s.margin="none"===u.margin?0:u.margin,s["box-shadow"]=t.style.boxShadow,i?(l["justify-content"]=i.horizontal?"flex-start":u.hAlign,l["align-items"]=i.vertical?"flex-start":u.vAlign):(l["justify-content"]=u.hAlign,l["align-items"]=u.vAlign),c.enabled?(s["border-radius"]=c.radius,s["border-color"]=d?c.hoverColor:c.color,s["border-style"]=c.style,s["border-width"]=c.width):!1===c.enabled&&(s["border-width"]="0"),h&&(s["background-color"]=(d?h.hoverColor:h.color)||s["background-color"],"image"===t.buttonType&&(s["background-image"]=h.image?"url("+h.image+")":null,h.position&&(s["background-position-y"]=h.position.y,s["background-position-x"]=h.position.x),s["background-repeat"]=h.repeat,s["background-size"]=h.size)),"custom"===t.buttonType&&"string"==typeof t.style.custom&&t.style.custom.split(";").forEach(function(t){var e=t.split(":");e.length<2||""===e[0].trim()||(s[e.shift().trim()]=e.join(":").trim())}),t.icon&&(f&&(r.color=d?f.hoverColor:f.color),!u.icon||"top"!==u.icon.position&&"bottom"!==u.icon.position||(r.display="block")),u.margin&&"none"!==u.margin&&("simple"===t.buttonType||"image"===t.buttonType||u.height)&&!("auto"===u.height||u.height&&0===u.height.indexOf("calc("))){var b=u.margin.split(" "),y=" - "+b[0]+" - "+b[b.length<3?0:2];s.height="calc("+(u.height||"100%")+y+")"}t.styles=s,t.iconStyles=r,t.containerStyles=l}})},applyClasses:function(t){t.forEach(function(t){if(t.buttonType){var e=[];e.push(l.types[t.buttonType].class),e.push(l.types[t.buttonType].value),t.hasActions||e.push("no-action-button"),t.buttonState&&e.push("lui-"+t.buttonState);var n=[],o=[];if(t.icon&&(0===t.icon.indexOf("fa-")&&n.push("fa"),0===t.icon.indexOf("lui-")&&n.push("lui-icon"),n.push(t.icon),t.style.icon&&(1===t.style.icon.size?n.push("fa-lg"):t.style.icon.size>1&&n.push("fa-"+t.style.icon.size+"x")),t.text))if(t.layout.icon)switch(t.layout.icon.position){case"top":case"bottom":break;case"right":n.push("p-l-xs"),o.push("flex-container");break;case"left":default:n.push("p-r-xs"),o.push("flex-container")}else n.push("p-r-xs"),o.push("flex-container");t.classes=e,t.iconClasses=n,t.contentClasses=o}})},$onInit:function(){function t(){var t=this;o.getActiveStates(o.states).then(function(e){try{e.forEach(function(e){o.doAction(t,e,"selection")})}catch(t){console.warn(t)}})}function n(){this.OnData.unbind(n),this.OnData.bind(t)}var o=this;this.onSelection=t,this.registerOnSelectionHandler=n,e.currApp().selectionState().OnData.bind(n),this.getActiveStates(this.states).then(function(t){try{t.forEach(function(t){o.inEditMode&&"edit"===e.navigation.getMode()||o.doAction({type:"load"},t,"load")})}catch(t){console.warn(t)}})},$onChanges:function(t){if(t){var e,n,o,i,s,a;for(this.states=t.states.currentValue,this.defaultStyles=t.defaultStyles.currentValue,e=0,o=this.states.length;e<o;e++)if(s=this.states[e],s.hasActions=!1,a=s.triggers,a.length>0)for(n=0,i=a.length;n<i;n++)if(a[n].actions.length>0){s.hasActions=!0;break}this.refreshActiveStates()}},onDestroy:function(){var t=e.currApp(),o=n.element(this),i=o.scope(),s=o.isolateScope().$ctrl;if(s.activeStates.forEach(function(t){s.doAction({type:"beforeUnload"},t,"beforeUnload")},s),s.unwatchChanges(),t){var a=t.selectionState();a.OnData.unbind(s.registerOnSelectionHandler),a.OnData.unbind(s.onSelection)}i.$element=null,s.$element=null}},l.Trigger=function(){this.type="click",this.actions=[new l.Action]},l.Action=function(){this.name="none",this.params={},this.paramsExpr={}},l.types={simple:{group:"General",class:"simple lui-button",value:"hico-custom-simple-button",label:"simple"},image:{group:"General",class:"image lui-button",value:"hico-custom-image-button",label:"image"},custom:{group:"General",class:"custom lui-button",value:"hico-custom-css-button",label:"custom"},"lui-button":{group:"Sense Button",class:"lui-button",value:"lui-button",label:"default"},"lui-button-danger":{group:"Sense Button",class:"lui-button",value:"lui-button--danger",label:"danger"},"lui-button-info":{group:"Sense Button",class:"lui-button",value:"lui-button--info",label:"info"},"lui-button-success":{group:"Sense Button",class:"lui-button",value:"lui-button--success",label:"success"},"lui-button-warning":{group:"Sense Button",class:"lui-button",value:"lui-button--warning",label:"warning"},"lui-fade-button":{group:"Sense Fade Button",class:"lui-fade-button",value:"lui-fade-button",label:"default"},"lui-fade-button-danger":{group:"Sense Fade Button",class:"lui-fade-button",value:"lui-fade-button--danger",label:"danger"},"lui-fade-button-info":{group:"Sense Fade Button",class:"lui-fade-button",value:"lui-fade-button--info",label:"info"},"lui-fade-button-success":{group:"Sense Fade Button",class:"lui-fade-button",value:"lui-fade-button--success",label:"success"},"lui-fade-button-warning":{group:"Sense Fade Button",class:"lui-fade-button",value:"lui-fade-button--warning",label:"warning"},"lui-overlay-button":{group:"Overlay",class:"lui-overlay-button",value:"lui-overlay-button",label:"overlay"}},l.Controller=u,l});