var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};define(["qvangular","qlik","ng!$q","../prefix"],function(e,t,n,i){function r(){function e(){return n.all([w.variableProvider.getReady(),w.expressionProvider.getReady()]).then(function(){return w})}function i(e,t,n){return e[t].bind(n),function(){e[t].unbind(n)}}function r(e){var t="object"===(void 0===e?"undefined":_typeof(e))&&e||{id:"",type:"GenericObject"};return{qInfo:{qId:t.id,qType:t.type}}}function u(e){return H.getObject(e).catch(M(H,"getObject",[e]))}function l(e){return E.getObject(e).catch(M(E,"getObject",[e]))}function f(e){var t=e,n="object"===(void 0===e?"undefined":_typeof(e))?e:null;return n&&(t=n.id||((n.properties||{}).qInfo||(n.layout||{}).qInfo).qId),E.getObjectProperties(t).catch(M(E,"getObjectProperties",[t]))}function p(e){return("string"==typeof e?f(e):Promise.resolve(e)).then(function(e){var t=e&&((e.properties||{}).qExtendsId||(e.layout||{}).qExtendsId);return t?f(t):e})}function d(e){return e.getLayout().catch(M(e,"getLayout",[]))}function h(e,t){var n="object"===(void 0===e?"undefined":_typeof(e))?e:null,i=n&&n.properties||null;return t&&i&&i.qInfo?Promise.resolve(i):f(e).then(function(e){return e&&e.properties||null})}function q(e,t,n){return e.applyPatches(t,n).catch(M(e,"applyPatches",[t,n]))}function y(e,t){return e.setProperties(t).catch(M(e,"setProperties",[t]))}function v(e){return e.qInitialDataFetch[0].qWidth=0,e.qInitialDataFetch[0].qHeight=0,e}function g(e){var t=Math.max(1,e.qDimensions.length+e.qMeasures.length),n=Math.floor(1e4/t);return e.qInitialDataFetch[0].qWidth=t,e.qInitialDataFetch[0].qHeight=n,e}function b(e){return H.createObject(e).catch(M(H,"createObject",[e]))}function m(e){return E.createGenericObject(e).catch(M(E,"createGenericObject",[e]))}function L(e,t){return console.info("createSessionCube",t),m({qInfo:{qId:t,qType:"HyperCube"},qHyperCubeDef:g(e)})}function O(e,t,n){return console.info("createChildCube",n),S(e,{qInfo:{qId:n,qType:"HyperCube"},qHyperCubeDef:g(t)})}function I(e,t){return console.info("updateChildCube",e),f(e).then(function(e){return t.hcIdx||console.error("Update a hyperCube without hcIdx",t),e.properties.qHyperCubeDef=g(t),y(e,e.properties).then(function(){return e})})}function D(e){return(e&&e.qChildList&&e.qChildList.qItems||[]).map(function(e){return{id:e.qInfo.qId,type:e.qInfo.qType,data:e.qData}})}function S(e,t){return e.createChild(t).catch(M(e,"createChild",[t]))}function j(e,t){return"function"==typeof e.destroyChild?e.destroyChild(t).catch(M(e,"destroyChild",[t])):e.removeChild(t).catch(M(e,"removeChild",[t]))}function x(e){return H.destroyObject(e).catch(M(H,"destroyObject",[e]))}function M(e,t,n,i){var i=(i||0)+1;return function(r){var o,s=r.error||r;switch(t?console.info("HICO: Error occurred during: "+t,15!==s.code?s:n):console.error("HICO: Error occurred",r),s.code){case 2:o=new Error("no object found with id "+n[0]),o.code=2;break;case 15:if("function"==typeof e[t]&&i<5)return console.info("try again"),Promise.resolve(e[t].apply(e,n||[])).catch(M(e,t,n,i));console.info(e,n),o=new Error("HICO: Give up after 5 tries to "+t),o.code=15}return Promise.reject(o)}}function k(){return!0===t.navigation.getCurrentSheetId().success}function T(){var e=t.navigation.getMode();return"play"===e||"editstory"===e}function V(){return"play"===t.navigation.getMode()}function P(){return"edit"===t.navigation.getMode()}function C(e){return e?e.ext&&e.ext.model?e:C(e.$parent):null}var w=this,E=t.currApp(),H=E.model.enigmaModel;this.bindListener=i,this.createGenericObjectDef=r,this.getObject=u,this.destroyObject=x,this.getObjectLayout=l,this.getObjectProperties=f,this.getMasterObjectProperties=p,this.getLayout=d,this.getProperties=h,this.applyPatches=q,this.setProperties=y,this.setMinInitialDataFetch=v,this.createObject=b,this.createSessionObject=m,this.createSessionCube=L,this.createChildCube=O,this.updateChildCube=I,this.getChildItems=D,this.createChild=S,this.removeChild=j,this.engineErrorHandler=M,this.onSheet=k,this.inStoryMode=T,this.inPlayMode=V,this.inEditMode=P,this.getExtensionScope=C,this.listProvider=new o(w,E),this.variableProvider=new a(w,E),this.expressionProvider=new s(w),this.selectionProvider=new c(w,E),this.evalExpression=this.expressionProvider.evalExpression,this.getVariableValue=this.variableProvider.getValue,this.setVariableStringValue=this.variableProvider.setStringValue,this.getVariableValueList=this.variableProvider.getValueList,this.getVariableValueObject=this.variableProvider.getValueObject,this.select=this.selectionProvider.select,this.debug={profileVariables:this.variableProvider.profile},this.getReady=e}function o(e,t){function r(n){return a(n).then(function(){if(void 0===u[n]){var i=c(n);i.qInfo.qId?u[n]=e.createSessionObject(i).then(function(e){return e}):u[n]=t.getList(i).catch(e.engineErrorHandler(t,"getList",[i]))}return u[n]})}function o(e){return a(e).then(function(t){return r(e).then(function(e){return e.layout[t]})})}function s(e){return a(e).then(function(t){return r(e).then(function(e){return e.layout[t].qItems})})}function a(e){var t=l[e];return void 0!==t?n.resolve(t):n.reject()}function c(e){switch(e){case"BookmarkList":return{qInfo:{qId:i+"BookmarkList",qType:"BookmarkList"},qBookmarkListDef:{qType:"bookmark",qData:{title:"/qMetaDef/title",description:"/qMetaDef/description"}}};case"DimensionList":return{qInfo:{qId:i+"DimensionList",qType:"DimensionList"},qDimensionListDef:{qType:"dimension",qData:{title:"/qMetaDef/title",tags:"/qMetaDef/tags",grouping:"/qDim/qGrouping",info:"/qDimInfos"}}};case"FieldList":return{qInfo:{qId:i+"FieldList",qType:"FieldList"},qFieldListDef:{qShowSystem:!1,qShowHidden:!0,qShowSrcTables:!0,qShowSemantic:!0,qShowDerivedFields:!0}};case"MasterObject":return{qInfo:{qId:i+"MasterObjectList",qType:"MasterObjectList"},qAppObjectListDef:{qType:"masterobject",qData:{name:"/qMetaDef/title",visualization:"/visualization",tags:"/qMetaDef/tags"}}};case"MeasureList":return{qInfo:{qId:i+"MeasureList",qType:"MeasureList"},qMeasureListDef:{qType:"measure",qData:{title:"/qMetaDef/title",tags:"/qMetaDef/tags"}}};case"MediaList":return{qInfo:{qId:i+"MediaList",qType:"MediaList"},qMediaListDef:{}};case"SelectionObject":return{qInfo:{qId:i+"CurrentSelection",qType:"SelectionObject"},qSelectionObjectDef:{}};case"sheet":return{qInfo:{qId:i+"SheetList",qType:"SheetList"},qAppObjectListDef:{qType:"sheet",qData:{title:"/qMetaDef/title",description:"/qMetaDef/description",thumbnail:"/thumbnail",cells:"/cells",rank:"/rank",columns:"/columns",rows:"/rows"}}};case"SnapshotList":return{qInfo:{qId:i+"SnapshotList",qType:"SnapshotList"},qBookmarkListDef:{qType:"snapshot",qData:{title:"/title",libraryTitle:"/qMetaDef/title",description:"/qMetaDef/description",sourceObjectId:"/sourceObjectId",visualizationType:"/visualizationType",timestamp:"/timestamp",snapshotData:"/snapshotData",isClone:"/isClone"}}};case"story":return{qInfo:{qId:i+"StoryList",qType:"StoryList"},qAppObjectListDef:{qType:"story",qData:{title:"/qMetaDef/title",description:"/qMetaDef/description",thumbnail:"/thumbnail",rank:"/rank"}}};case"VariableList":return{qInfo:{qId:i+"VariableList",qType:"VariableList"},qVariableListDef:{qType:"variable",qData:{tags:"/tags"}}};default:var t="q"+e+"Def",n={qInfo:{qType:e}};return n[t]={},n}}var u={},l={FieldList:"qFieldList",MeasureList:"qMeasureList",DimensionList:"qDimensionList",BookmarkList:"qBookmarkList",SelectionObject:"qSelectionObject",SnapshotList:"qSnapshotList",MediaList:"qMediaList",MasterObject:"qMasterObject",VariableList:"qVariableList",story:"qAppObjectList",sheet:"qAppObjectList"};this.getList=r,this.getListData=o,this.getListItems=s}function s(e){function t(e){function t(e){var t,n,i=0;if(0===e.length)return i;for(t=0;t<e.length;t++)n=e.charCodeAt(t),i=(i<<5)-i+n,i|=0;return{key:"e"+i,def:e}}return"string"==typeof e&&0===e.indexOf("=")?t(e):"object"===(void 0===e?"undefined":_typeof(e))&&e.hasOwnProperty("qStringExpression")?t("string"==typeof e.qStringExpression?e.qStringExpression:e.qStringExpression.qExpr):null}function i(e){return o().then(function(){var n=u,i=t(e);return n.properties.exprList&&n.properties.exprList.hasOwnProperty(i.key)&&n.properties.exprList[i.key].qStringExpression!==i.def&&(console.error("Collision found..., it seems like we need a better hash algorythm: "+i.key),console.warn(i.expr,n.properties.exprList[i.key])),null===i?e:n.layout.exprList.hasOwnProperty(i.key)?n.layout.exprList[i.key]:q.hasOwnProperty(i.key)?q[i.key]:r(i)})}function r(e){var t=n.defer();return clearTimeout(l),q[e.key]=t.promise,d.push({qPath:"/exprList/"+e.key,qOp:"add",qValue:JSON.stringify({qStringExpression:e.def})}),p.push({key:e.key,promise:t}),l=setTimeout(s,20),t.promise}function o(){return y.promise}function s(){var t=d,n=p;d=[],p=[],h.push(n.slice()),o().then(function(){e.applyPatches(u,t,!0)})}function a(){for(var e=this.layout.exprList;h.length>0;){h.shift().forEach(function(t){t.promise.resolve(e[t.key])})}y.resolve(f),y.resolved=!0}function c(){y.resolved&&(y=n.defer())}var u,l,f=this,p=[],d=[],h=[],q={},y=n.defer();f.getReady=o,f.evalExpression=i,function(){e.createSessionObject({qInfo:{qId:"hicoExpressionValueList",qType:"GenericObject"},exprList:{}}).then(function(e){u=e,u.Validated.bind(a),u.Invalidated.bind(c),a.apply(u)})}()}function a(e,r){function o(e){return e&&(D=e),q().then(a)}function s(){return clearTimeout(O),j.resolved&&(j=n.defer()),O=setTimeout(function(){q().then(a).then(function(){j.resolved=!0,j.resolve()})},S),j.promise}function a(){var t=l(L.layout.varValueList,D);return t.length>0&&(y(!1),e.applyPatches(L,t,!0)),q()}function c(e){return-1===D.indexOf(e)}function u(e){D.push(e)}function l(e,t){var n,r,o,s,a,c,u=[],l=[],f={};for(n=0;n<t.length;n++)r=t[n],o="v"+b(r),void 0===e[o]?(a="tcmenu"===i?r:"$("+r+")",c={qName:r,str:{qStringExpression:{qExpr:a}}},"tcmenu"!==i&&(c.fallback={qStringExpression:{qExpr:r}}),u.push({qPath:"/varValueList/"+o,qOp:"add",qValue:JSON.stringify(c)})):f[o]=!0;for(s=Object.keys(e),n=0;n<s.length;n++)o=s[n],f[o]||l.push({qPath:"/varValueList/"+o,qOp:"remove"});return u.concat(l)}function f(e){var t;return"string"!=typeof e?Promise.reject('Wrong parameter type: "name" must be from type "string" but is from type "'+(void 0===e?"undefined":_typeof(e))+'"'):(c(e)?(u(e),t=s().then(q)):t=q(),n.resolve(t).then(function(){var t=L.layout.varValueList["v"+b(e)];return void 0!==t?t.str:t}))}function p(t,n){return r.variable.setStringValue(t,n).catch(e.engineErrorHandler(r.variable,"setStringValue",[t,n]))}function d(){return q().then(function(){return L.layout.varValueList})}function h(){return q().then(function(){return L})}function q(){return x.promise}function y(e){!1===e&&x.resolved?(x=n.defer(),x.startTime=Date.now()):!1!==e&&(x.resolved=!0,x.resolve(I))}function v(){x.startTime&&console.info("Variables validated after: "+(Date.now()-x.startTime)/1e3+"s"),y()}function g(){void 0!==x.resolved&&console.info("Variables invalidated"),y(!1)}function b(e){return e.replace(/\//g,"hico$$.$$hico")}function m(n){q().then(d).then(function(r){function o(i,u){if(!i)return t.Promise.resolve();var f=!1===n?"="+i:"=$("+i+")";return p[i]=Date.now(),a.evaluateExpression(f).catch(e.engineErrorHandler(a,"evaluateExpression",[f])).then(function(e){if(p[i]={calcTime:Date.now()-p[i],value:e},++c<l)return u=s[c],i=r[u].qName,o(i,u)})}var s=Object.keys(r),a=t.currApp().model,c=0,u=s[c],l=s.length,f=(r[u]||{}).qName,p={},d=Date.now();console.info("Start profiling variables ("+i+")"),o(f,u).then(function(){console.info("Finish profiling variables ("+i+") after: "+(Date.now()-d)/1e3+"s");var e=[];for(var t in p)e.push({name:t,calcTime:p[t].calcTime,value:p[t].value});e.sort(function(e,t){return t.calcTime-e.calcTime}),console.info({all:e,errors:e.filter(function(e){return e.value.indexOf("Error")>-1}),invalid:e.filter(function(e){return"-"===e.value})})})})}var L,O,I=this,D=[],S=20,j=n.defer(),x=n.defer();this.getReady=q,this.getValue=f,this.getValueList=d,this.getValueObject=h,this.setStringValue=p,this.setUsedVariables=o,this.profile=m,function(){e.createSessionObject({qInfo:{qId:i+"VariableValueList",qType:"GenericObject"},varValueList:{}}).then(function(e){L=e,L.Validated.bind(v),L.Invalidated.bind(g),y()})}()}function c(e,t){function i(s,a,c,l,f){var p=this,d=arguments,h=o[s];if(!("string"==typeof s&&s.length>0&&a.constructor===Array&&a.length>0))return n.reject("No valid parameters",arguments);if(!h||!h.pending){if(f&&r(s))return n.resolve(!0);h=o[s]={promise:t.field(s).select(a,!!c,!!l).catch(e.engineErrorHandler(t.field(s),"select",[a,!!c,!!l])),arguments:d,pending:!0,counter:0}}return n.resolve(h.promise).then(function(e){if(h.pending=!1,!e)return h.counter>2?(console.warn('Selection of fieldName "'+h.arguments[0]+'" failed '+h.counter+" times, request aborted...",h.arguments),!1):(console.warn('Selection of fieldName "'+h.arguments[0]+"\" wasn't successfull, try again",h.arguments),h.counter++,i.apply(p,h.arguments));var t=h.arguments;u(t[1],d[1])&&!f&&(console.info("Override previous selection",{prev:t,curr:d}),i.apply(p,d))})}function r(e){var t=o[e],n=c.indexOf(e)>-1,i=a&&a[e];return n||i?n:!(!t||!t.pending)}var o={},s=[],a={},c=[];this.select=i,function(){t.selectionState().OnData.bind(function(){s=this.selections,a=this.qapp.fieldCache,c=new Array(s.length);for(var e=0,t=s.length;e<t;e++)c[e]=s[e].fieldName})}()}function u(e,t){function n(e,t){for(var n=0,i=t.length;n<i;n++)if(-1===e.indexOf(t[n]))return!0;return!1}return e.length===t.length&&n(e,t)&&n(t,e)&&!1}return e.service(i+"QlikService",[r]),r.getInstance=function(){return e.getService(i+"QlikService")},r});