define(["./qlik-service"],function(e){function t(t){function i(){return Promise.all([r.mediaProvider.getReady()]).then(function(){return r})}var r=this,o=e.getInstance(t);this.mediaProvider=new n(o),this.getReady=i}function n(e){function t(){return O().then(function(){return N})}function n(e){C={},N=e.map(function(e){var t={id:e.id,type:e.type,tcMedia:e.data};return C[t.tcMedia.name]=t,t})}function o(t){return O().then(function(){if(!L[t]&&N.length>0){var n=g(t);n&&(L[t]=e.getObjectProperties(n.id))}return L[t]||Promise.resolve(null)})}function s(e){return o(e).then(function(e){return e?e.properties.tcMedia.data:null})}function c(e){return s(D(e))}function d(e,t,n){return new Promise(function(i,o){!0===n?l(e,t).then(i,o):!1===n&&g(e)?o(r('name "'+e+'" is in use!',u.CONFLICT)):f(y(e),t).then(i,o)})}function f(t,n){return new Promise(function(i,r){var o=w(t,n);e.createChild(U,o).then(O).then(function(){i(g(t))},r)})}function l(t,n){return new Promise(function(i,o){var a=g(t);a||o(r("No media found with name: "+t,u.NOT_FOUND)),e.getObjectProperties(a.id).then(function(i){return i.properties.tcMedia=w(t,n).tcMedia,e.setProperties(i,i.properties)}).then(O).then(function(){i(g(t))},o)})}function h(t,n){return o(t).then(function(i){if(null===i)throw r("No media found with name: "+t,u.NOT_FOUND);if(g(n))throw r('Target name "'+n+'" is already in use!',u.CONFLICT);return delete L[t],i.properties.tcMedia.name=n,i.properties.tcMedia.url=a+n,e.setProperties(i,i.properties).then(O).then(function(){return g(n)})})}function m(t){return O().then(function(){var n=g(t);return!!n&&(delete L[t],e.removeChild(U,n.id).then(function(){return!0}))})}function p(e,t){return new Promise(function(n,i){if("string"!=typeof e||0===e.length)throw r("URL must be a valid string",u.BAD_REQUEST);E(e).then(function(r){d(D(e),r,t).then(n,i)},i)})}function v(e,t){return new Promise(function(n,i){if(e instanceof File!=!0)throw r('file must be an instance of "File"',u.BAD_REQUEST);b(e).then(function(r){d(e.name,r,t).then(n,i)},i)})}function M(e){return"string"==typeof e&&0===e.indexOf(a)}function w(t,n){var i=e.createGenericObjectDef({type:"tcMedia"});return i.tcMedia={data:n.data,lastModified:n.lastModified,name:t,size:n.size,source:n.source,url:a+t},i}function g(e){return C[e]||null}function y(e){for(var t=1,n=e.split("."),i=n.pop(),r=n.join("."),o=e;g(o);)o=r+"("+t+")."+i,t++;return o}function D(e){var t="Unknown";return M(e)?t=e.substr(a.length):0!==e.indexOf("data:")&&(t=e.split("?").shift().split("/").pop()),t}function O(){return I.promise}function P(e){!1===e&&I.resolved?I=new i:!1!==e&&(I.resolved=!0,I.resolve(F))}function b(e){return new Promise(function(t,n){var i=new FileReader;i.onerror=function(e){n(e)},i.onload=function(){var n={name:e.name,data:this.result,lastModified:e.lastModifiedDate,type:e.type,size:e.size,source:"file://"+e.name};t(n)},i.readAsDataURL(e)})}function E(e){return new Promise(function(t,n){var i=new XMLHttpRequest;i.onerror=function(){n(r(this.statusText,this.status))},i.onload=function(){var n={data:null,lastModified:this.getResponseHeader("last-modified"),type:this.getResponseHeader("content-type"),size:this.response.size,source:e},i=new FileReader;i.onload=function(){n.data=this.result,t(n)},i.readAsDataURL(this.response)},i.open("GET",e),i.responseType="blob",i.send()})}function T(e){function t(e,t){var n=document.createElement("a");if(n.setAttribute("href",t),n.setAttribute("download",e),document.createEvent){var i=document.createEvent("MouseEvents");i.initEvent("click",!0,!0),n.dispatchEvent(i)}else n.click()}return O().then(function(n){return n.getMediaData(e).then(function(n){t(e,n)})})}function R(){return void 0!==document.createElement("a").download}var F=this,I=new i,U={},N=[],C={},L={};this.getReady=O,this.getMediaItems=t,this.getMediaItemByName=g,this.getMediaData=s,this.getMediaDataByUrl=c,this.addMediaFromUrl=p,this.addMediaFromFile=v,this.removeMedia=m,this.renameMedia=h,this.isTcMediaUrl=M,this.fileToData=b,this.downloadMedia=T,this.isDownloadSupported=R,function(){var t={qInfo:{qId:"tcMediaStore",qType:"tcMediaStore"},qChildListDef:{qData:{lastModified:"/tcMedia/lastModified",name:"/tcMedia/name",size:"/tcMedia/size",source:"/tcMedia/source",url:"/tcMedia/url"}},version:1};e.getObject("tcMediaStore").then(function(n){return n||e.createObject(t)},function(n){return n&&2===n.code?e.createObject(t):Promise.reject(n)}).then(function(t){return U=t,t.Invalidated.bind(function(){P(!1),e.getLayout(this)}),t.Validated.bind(function(){n(e.getChildItems(this.layout)),P(!0)}),e.getLayout(t)}).then(function(t){n(e.getChildItems(t)),P(!0)}).catch(function(e){console.error(e)})}()}function i(){var e=this;e.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})}function r(e,t){var n=new Error(e);return n.code=t,n}var o={},a="tcml:",u={BAD_REQUEST:400,NOT_FOUND:404,CONFLICT:409};return t.getInstance=function(e){if("string"!=typeof e||!e)throw new Error("appId must be a not empty string");return o[e]||(o[e]=new t(e)),o[e]},t});